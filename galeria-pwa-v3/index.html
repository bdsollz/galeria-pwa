<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Minha Galeria</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#121212">
<style>
body{margin:0;background:#121212;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;color:#fff}
h1{padding:20px 15px;margin:0}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;padding:0 12px 100px}
.card{position:relative;background:#1e1e1e;border-radius:16px;overflow:hidden;aspect-ratio:9/14}
.card img{width:100%;height:100%;object-fit:cover}
.card-bottom{position:absolute;bottom:0;width:100%;padding:20px 10px 10px;background:linear-gradient(to top,rgba(0,0,0,.9),rgba(0,0,0,0))}
.name{font-weight:600;font-size:15px}
.ref{font-size:12px;color:#ccc}
.edit-btn{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.6);border:none;color:#fff;border-radius:50%;width:30px;height:30px;font-size:14px}
.fab{position:fixed;bottom:30px;right:30px;width:60px;height:60px;border-radius:50%;background:#fff;color:#000;font-size:30px;border:none}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center}
.modal-content{background:#1e1e1e;padding:20px;border-radius:20px;width:90%;max-width:400px}
input{width:100%;margin:10px 0;padding:10px;border-radius:8px;border:none;background:#333;color:#fff}
.thumb-row{display:flex;gap:8px;overflow-x:auto;margin:10px 0}
.thumb-row img{width:60px;height:80px;object-fit:cover;border-radius:8px}
.carousel{display:flex;overflow:hidden;width:100%;height:100%}
.carousel img{width:100%;flex-shrink:0;object-fit:contain}
</style>
</head>
<body>
<h1>Minha Galeria</h1>
<div class="grid" id="grid"></div>
<button class="fab" onclick="openEdit()">+</button>

<div class="modal" id="editModal">
<div class="modal-content">
<h3 id="modalTitle">Nova Pessoa</h3>
<input type="text" id="nameInput" placeholder="Nome">
<input type="text" id="refInput" placeholder="Referência">
<input type="file" id="photoInput" multiple accept="image/*">
<div class="thumb-row" id="thumbRow"></div>
<button onclick="savePerson()">Salvar</button>
<button onclick="closeEdit()">Cancelar</button>
</div>
</div>

<div class="modal" id="viewModal">
<div class="carousel" id="carousel"></div>
</div>

<script>
let db;
let editingId=null;

const request=indexedDB.open("galeriaDB",1);
request.onupgradeneeded=e=>{
db=e.target.result;
db.createObjectStore("people",{keyPath:"id",autoIncrement:true});
};
request.onsuccess=e=>{db=e.target.result;render();};

function compressImage(file){
return new Promise(resolve=>{
const img=new Image();
const reader=new FileReader();
reader.onload=e=>{
img.onload=()=>{
const canvas=document.createElement("canvas");
const max=1000;
let w=img.width,h=img.height;
if(w>h && w>max){h*=max/w;w=max}
if(h>w && h>max){w*=max/h;h=max}
canvas.width=w;canvas.height=h;
canvas.getContext("2d").drawImage(img,0,0,w,h);
resolve(canvas.toDataURL("image/jpeg",0.8));
};
img.src=e.target.result;
};
reader.readAsDataURL(file);
});
}

function render(){
const tx=db.transaction("people","readonly").objectStore("people").getAll();
tx.onsuccess=e=>{
const data=e.target.result;
const grid=document.getElementById("grid");
grid.innerHTML="";
data.forEach(p=>{
const card=document.createElement("div");
card.className="card";
card.innerHTML=`
<button class="edit-btn" onclick="openEdit(${p.id})">✏</button>
<img src="${p.photos?.[0]||''}" onclick="openView(${p.id})">
<div class="card-bottom">
<div class="name">${p.name}</div>
<div class="ref">${p.reference}</div>
</div>`;
grid.appendChild(card);
});
};
}

async function savePerson(){
const name=document.getElementById("nameInput").value;
const reference=document.getElementById("refInput").value;
const files=[...document.getElementById("photoInput").files].slice(0,5);
let photos=[];
for(const f of files){
photos.push(await compressImage(f));
}
const tx=db.transaction("people","readwrite").objectStore("people");
if(editingId){
tx.put({id:editingId,name,reference,photos});
}else{
tx.add({name,reference,photos});
}
closeEdit();
render();
}

function openEdit(id=null){
editingId=id;
document.getElementById("editModal").style.display="flex";
}

function closeEdit(){
editingId=null;
document.getElementById("editModal").style.display="none";
}

function openView(id){
const tx=db.transaction("people","readonly").objectStore("people").get(id);
tx.onsuccess=e=>{
const p=e.target.result;
const carousel=document.getElementById("carousel");
carousel.innerHTML="";
p.photos.forEach(src=>{
const img=document.createElement("img");
img.src=src;
carousel.appendChild(img);
});
document.getElementById("viewModal").style.display="flex";
};
}

document.getElementById("viewModal").onclick=()=>{
document.getElementById("viewModal").style.display="none";
};
</script>
</body>
</html>
